<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í˜ì´ì§€ - ì‡¼í•‘ëª°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }

        .navbar {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            text-decoration: none;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background-color: #5568d3;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            background: white;
            padding: 2rem;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .page-header h1 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: #666;
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs {
            background: white;
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 1.2rem;
            text-align: center;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            background: white;
            border: none;
            transition: all 0.3s;
            position: relative;
        }

        .tab:hover {
            background-color: #f7fafc;
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            background-color: #f0f4ff;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #667eea;
        }

        .tab-content {
            background: white;
            padding: 2rem;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ì£¼ë¬¸ ë‚´ì—­ ìŠ¤íƒ€ì¼ */
        .orders-grid {
            display: grid;
            gap: 1.5rem;
        }

        .order-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .order-number {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-paid {
            background-color: #c6f6d5;
            color: #22543d;
        }

        .order-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }

        .order-total {
            text-align: right;
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        /* ë¬¸ì˜ ë‚´ì—­ ìŠ¤íƒ€ì¼ */
        .inquiry-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .inquiry-item {
            background: #f9f9f9;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        .inquiry-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .inquiry-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .inquiry-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .secret-badge {
            font-size: 0.9rem;
            color: #f56565;
        }

        .inquiry-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .inquiry-content {
            padding: 1rem;
            background-color: white;
            border-radius: 4px;
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #333;
        }

        .inquiry-answer {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f0f4ff;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }

        .answer-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .answer-content {
            color: #333;
            line-height: 1.6;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h2 {
            color: #333;
            margin-bottom: 1rem;
        }

        .empty-state p {
            color: #666;
            margin-bottom: 2rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .tab {
                border-bottom: 1px solid #e2e8f0;
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .order-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="logo">ğŸ›’ ì‡¼í•‘ëª°</a>
            <div class="nav-buttons">
                <a href="/products" class="btn">ìƒí’ˆ ëª©ë¡</a>
                <a href="/" class="btn btn-primary">í™ˆ</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>ë§ˆì´í˜ì´ì§€</h1>
            <p>ì£¼ë¬¸ ë‚´ì—­ê³¼ ë¬¸ì˜ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('orders')">
                ğŸ“¦ ì£¼ë¬¸ ë‚´ì—­
            </button>
            <button class="tab" onclick="switchTab('wishlist')">
                â¤ï¸ ìœ„ì‹œë¦¬ìŠ¤íŠ¸
            </button>
            <button class="tab" onclick="switchTab('inquiries')">
                ğŸ’¬ ë¬¸ì˜ ë‚´ì—­
            </button>
        </div>

        <div class="tab-content">
            <!-- ì£¼ë¬¸ ë‚´ì—­ íƒ­ -->
            <div id="orders-tab" class="tab-pane active">
                <div id="ordersContent">
                    <div class="loading">ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <!-- ìœ„ì‹œë¦¬ìŠ¤íŠ¸ íƒ­ -->
            <div id="wishlist-tab" class="tab-pane">
                <div id="wishlistContent">
                    <div class="loading">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>

            <!-- ë¬¸ì˜ ë‚´ì—­ íƒ­ -->
            <div id="inquiries-tab" class="tab-pane">
                <div id="inquiriesContent">
                    <div class="loading">ë¬¸ì˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'orders';
        let ordersLoaded = false;
        let wishlistLoaded = false;
        let inquiriesLoaded = false;

        window.addEventListener('DOMContentLoaded', () => {
            loadOrders();
        });

        function switchTab(tabName) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // íƒ­ íŒ¨ë„ í™œì„±í™”
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            currentTab = tabName;

            // ë°ì´í„° ë¡œë“œ
            if (tabName === 'orders' && !ordersLoaded) {
                loadOrders();
            } else if (tabName === 'wishlist' && !wishlistLoaded) {
                loadWishlist();
            } else if (tabName === 'inquiries' && !inquiriesLoaded) {
                loadInquiries();
            }
        }

        // ========== ì£¼ë¬¸ ë‚´ì—­ ==========

        async function loadOrders() {
            try {
                const response = await fetch('/api/orders');
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                const orders = await response.json();
                displayOrders(orders);
                ordersLoaded = true;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('ordersContent').innerHTML =
                    '<div class="loading">ì£¼ë¬¸ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        function displayOrders(orders) {
            const ordersContent = document.getElementById('ordersContent');

            if (!orders || orders.length === 0) {
                ordersContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“¦</div>
                        <h2>ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h2>
                        <p>ì²« ì£¼ë¬¸ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                        <a href="/products" class="btn btn-primary">ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°</a>
                    </div>
                `;
                return;
            }

            const ordersHtml = orders.map(order => {
                const statusText = getStatusText(order.status);
                const itemCount = order.items ? order.items.length : 0;
                const itemsText = order.items && order.items.length > 0
                    ? `${order.items[0].productName}${itemCount > 1 ? ` ì™¸ ${itemCount - 1}ê±´` : ''}`
                    : 'ìƒí’ˆ ì •ë³´ ì—†ìŒ';

                return `
                    <div class="order-card" onclick="viewOrderDetail(${order.id})">
                        <div class="order-header">
                            <div class="order-number">ì£¼ë¬¸ë²ˆí˜¸: ${order.orderNumber}</div>
                            <span class="order-status status-paid">${statusText}</span>
                        </div>
                        <div class="order-info">
                            <div class="info-item">
                                <span class="info-label">ì£¼ë¬¸ ì¼ì‹œ</span>
                                <span class="info-value">${new Date(order.createdAt).toLocaleString('ko-KR')}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ê²°ì œ ìˆ˜ë‹¨</span>
                                <span class="info-value">${order.paymentMethod}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ì£¼ë¬¸ ìƒí’ˆ</span>
                                <span class="info-value">${itemsText}</span>
                            </div>
                        </div>
                        <div class="order-total">
                            ì´ ${order.totalAmount.toLocaleString()}ì›
                        </div>
                    </div>
                `;
            }).join('');

            ordersContent.innerHTML = `<div class="orders-grid">${ordersHtml}</div>`;
        }

        function getStatusText(status) {
            switch (status) {
                case 'PAID':
                    return 'ê²°ì œ ì™„ë£Œ';
                case 'PENDING':
                    return 'ê²°ì œ ëŒ€ê¸°';
                case 'CANCELLED':
                    return 'ì·¨ì†Œë¨';
                default:
                    return status;
            }
        }

        function viewOrderDetail(orderId) {
            window.location.href = `/orders/${orderId}`;
        }

        // ========== ë¬¸ì˜ ë‚´ì—­ ==========

        async function loadInquiries() {
            try {
                const response = await fetch('/api/users/me/inquiries');
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('ë¬¸ì˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                const inquiries = await response.json();
                displayInquiries(inquiries);
                inquiriesLoaded = true;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('inquiriesContent').innerHTML =
                    '<div class="loading">ë¬¸ì˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        function displayInquiries(inquiries) {
            const inquiriesContent = document.getElementById('inquiriesContent');

            if (!inquiries || inquiries.length === 0) {
                inquiriesContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’¬</div>
                        <h2>ë¬¸ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h2>
                        <p>ìƒí’ˆì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ë¬¸ì˜í•´ë³´ì„¸ìš”!</p>
                        <a href="/products" class="btn btn-primary">ìƒí’ˆ ë³´ëŸ¬ ê°€ê¸°</a>
                    </div>
                `;
                return;
            }

            const inquiriesHtml = inquiries.map(inquiry => {
                const date = new Date(inquiry.createdAt).toLocaleDateString('ko-KR');
                const secretBadge = inquiry.isSecret ? '<span class="secret-badge">ğŸ”’ ë¹„ë°€ê¸€</span>' : '';
                const answerStatus = inquiry.answer ? '<span style="color: #667eea;">âœ“ ë‹µë³€ì™„ë£Œ</span>' : '<span style="color: #999;">ë‹µë³€ëŒ€ê¸°</span>';

                let answerHTML = '';
                if (inquiry.answer) {
                    const answerDate = new Date(inquiry.answeredAt).toLocaleDateString('ko-KR');
                    answerHTML = `
                        <div class="inquiry-answer">
                            <div class="answer-label">ê´€ë¦¬ì ë‹µë³€ (${answerDate})</div>
                            <div class="answer-content">${inquiry.answer}</div>
                        </div>
                    `;
                }

                return `
                    <div class="inquiry-item">
                        <div class="inquiry-header">
                            <div class="inquiry-title">
                                ${inquiry.title}
                                ${secretBadge}
                            </div>
                            <div>${answerStatus}</div>
                        </div>
                        <div class="inquiry-meta">
                            <span>ì‘ì„±ì¼: ${date}</span>
                            <span>ìƒí’ˆ ID: ${inquiry.productId}</span>
                        </div>
                        <div class="inquiry-content">${inquiry.content}</div>
                        ${answerHTML}
                    </div>
                `;
            }).join('');

            inquiriesContent.innerHTML = `<div class="inquiry-list">${inquiriesHtml}</div>`;
        }

        // ========== ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ==========

        async function loadWishlist() {
            try {
                const response = await fetch('/api/wishlist');
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }

                const wishlist = await response.json();
                displayWishlist(wishlist);
                wishlistLoaded = true;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('wishlistContent').innerHTML =
                    '<div class="loading">ìœ„ì‹œë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        function displayWishlist(wishlist) {
            const wishlistContent = document.getElementById('wishlistContent');

            if (!wishlist || wishlist.length === 0) {
                wishlistContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ’”</div>
                        <h2>ìœ„ì‹œë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</h2>
                        <p>ë§ˆìŒì— ë“œëŠ” ìƒí’ˆì„ ìœ„ì‹œë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
                        <a href="/products" class="btn btn-primary">ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°</a>
                    </div>
                `;
                return;
            }

            const wishlistHtml = wishlist.map(item => {
                const stockStatus = item.productStock > 10
                    ? `<span style="color: #48bb78;">ì¬ê³  ì¶©ë¶„</span>`
                    : item.productStock > 0
                        ? `<span style="color: #f56565;">ì¬ê³  ${item.productStock}ê°œ</span>`
                        : `<span style="color: #f56565;">í’ˆì ˆ</span>`;

                return `
                    <div class="order-card" style="cursor: default;">
                        <div style="display: flex; gap: 1.5rem;">
                            <img src="${item.productImageUrl || 'https://via.placeholder.com/150'}" 
                                 alt="${item.productName}" 
                                 style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; cursor: pointer;"
                                 onclick="window.location.href='/products/${item.productId}'"
                                 onerror="this.src='https://via.placeholder.com/150'">
                            <div style="flex: 1;">
                                <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; cursor: pointer;"
                                     onclick="window.location.href='/products/${item.productId}'">
                                    ${item.productName}
                                </div>
                                ${item.productCategory ? `<span style="display: inline-block; padding: 0.25rem 0.5rem; background-color: #e2e8f0; border-radius: 4px; font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">${item.productCategory}</span>` : ''}
                                <div style="font-size: 1.3rem; font-weight: bold; color: #667eea; margin: 0.5rem 0;">
                                    ${item.productPrice.toLocaleString()}ì›
                                </div>
                                <div style="margin-bottom: 1rem;">${stockStatus}</div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-primary" 
                                            onclick="addToCartFromWishlist(${item.productId})"
                                            ${item.productStock <= 0 ? 'disabled' : ''}
                                            style="${item.productStock <= 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                                        ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°
                                    </button>
                                    <button class="btn" 
                                            style="background-color: #f56565; color: white;"
                                            onclick="removeFromWishlistInMypage(${item.productId})">
                                        ì‚­ì œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            wishlistContent.innerHTML = `<div class="orders-grid">${wishlistHtml}</div>`;
        }

        async function removeFromWishlistInMypage(productId) {
            if (!confirm('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }

            try {
                const response = await fetch(`/api/wishlist/${productId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadWishlist(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì œê±°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }

        async function addToCartFromWishlist(productId) {
            try {
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: productId,
                        quantity: 1
                    })
                });

                if (response.ok) {
                    if (confirm('ì¥ë°”êµ¬ë‹ˆì— ë‹´ì•˜ìŠµë‹ˆë‹¤!\nì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        window.location.href = '/cart';
                    }
                } else {
                    const error = await response.text();
                    alert(error || 'ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
        }
    </script>
</body>

</html>