<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.shoppingjpa.mapper.ProductInquiryMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="ProductInquiryResultMap" type="com.example.shoppingjpa.vo.ProductInquiry">
        <id property="id" column="id"/>
        <result property="productId" column="product_id"/>
        <result property="userId" column="user_id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="isSecret" column="is_secret"/>
        <result property="answer" column="answer"/>
        <result property="answeredAt" column="answered_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="username" column="username"/>
        <result property="name" column="user_name"/>
    </resultMap>

    <!-- 문의 등록 -->
    <insert id="insertInquiry" parameterType="com.example.shoppingjpa.vo.ProductInquiry"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO product_inquiries (product_id, user_id, title, content, is_secret)
        VALUES (#{productId}, #{userId}, #{title}, #{content}, #{isSecret})
    </insert>

    <!-- 상품별 문의 목록 조회 (사용자 정보 포함) -->
    <select id="findByProductId" resultMap="ProductInquiryResultMap">
        SELECT 
            pi.id,
            pi.product_id,
            pi.user_id,
            pi.title,
            pi.content,
            pi.is_secret,
            pi.answer,
            pi.answered_at,
            pi.created_at,
            pi.updated_at,
            u.username,
            u.name as user_name
        FROM product_inquiries pi
        INNER JOIN users u ON pi.user_id = u.id
        WHERE pi.product_id = #{productId}
        ORDER BY pi.created_at DESC
    </select>

    <!-- 문의 상세 조회 -->
    <select id="findById" resultMap="ProductInquiryResultMap">
        SELECT 
            pi.id,
            pi.product_id,
            pi.user_id,
            pi.title,
            pi.content,
            pi.is_secret,
            pi.answer,
            pi.answered_at,
            pi.created_at,
            pi.updated_at,
            u.username,
            u.name as user_name
        FROM product_inquiries pi
        INNER JOIN users u ON pi.user_id = u.id
        WHERE pi.id = #{id}
    </select>

    <!-- 관리자 답변 등록 -->
    <update id="updateAnswer">
        UPDATE product_inquiries
        SET answer = #{answer},
            answered_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <!-- 문의 삭제 -->
    <delete id="deleteInquiry">
        DELETE FROM product_inquiries
        WHERE id = #{id}
    </delete>

    <!-- 상품별 문의 개수 -->
    <select id="countByProductId" resultType="int">
        SELECT COUNT(*)
        FROM product_inquiries
        WHERE product_id = #{productId}
    </select>

    <!-- 사용자별 문의 목록 조회 (상품 정보 포함) -->
    <select id="findByUserId" resultMap="ProductInquiryResultMap">
        SELECT 
            pi.id,
            pi.product_id,
            pi.user_id,
            pi.title,
            pi.content,
            pi.is_secret,
            pi.answer,
            pi.answered_at,
            pi.created_at,
            pi.updated_at,
            u.username,
            u.name as user_name
        FROM product_inquiries pi
        INNER JOIN users u ON pi.user_id = u.id
        WHERE pi.user_id = #{userId}
        ORDER BY pi.created_at DESC
    </select>

</mapper>
